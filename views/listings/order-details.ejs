<% layout("/layout/bollerplate") %>

<%
  // ‚úÖ Expected delivery = Order date + 7 days
  const expectedDelivery = new Date(order.orderDate);
  expectedDelivery.setDate(expectedDelivery.getDate() + 7);
%>

<div class="container mt-5 mb-5">
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">

      <!-- ‚úÖ Order Header -->
      <div class="card shadow-sm mb-4 p-4 border-0 rounded-4 bg-light">
        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between">
          <div class="d-flex align-items-center mb-3 mb-md-0">
            <div class="me-3" style="font-size:40px;">
              <%= order.status === 'Cancelled' ? '‚ùå' :
                  order.status === 'Delivered' ? 'üéâ' : 'üì¶' %>
            </div>
            <div>
              <h3 class="mb-1">
                <%= order.status === 'Pending' ? 'Order Pending' :
                    order.status === 'Confirmed' ? 'Order Confirmed' :
                    order.status === 'Shipped' ? 'Order Shipped' :
                    order.status === 'Delivered' ? 'Order Delivered' :
                    'Order Cancelled' %>
              </h3>
              <p class="text-muted mb-0">
                Thank you for shopping with <strong>AkStore</strong>
              </p>
            </div>
          </div>

          <!-- üîò Action Buttons -->
          <div class="text-start text-md-end w-100 w-md-auto">
            <% if (order.status === 'Confirmed' || order.status === 'Shipped') { %>
              <form action="/order/<%= order._id %>/cancel" method="POST"
                    onsubmit="return confirm('Are you sure you want to cancel this order?');">
                <button class="btn btn-outline-danger btn-sm mb-2 w-100 w-md-auto">
                  ‚ùå Cancel Order
                </button>
              </form>
            <% } %>

            <% if (['Confirmed','Shipped','Delivered'].includes(order.status)) { %>
              <a href="/order/<%= order._id %>/invoice"
                 class="btn btn-outline-primary btn-sm w-100 w-md-auto">
                üìÑ Download Invoice
              </a>
            <% } %>
          </div>
        </div>
      </div>

      <!-- üõí Order Details -->
      <div class="card shadow-sm mb-4 p-4 border-0 rounded-4">
        <h4 class="mb-3">Order Details</h4>

        <p><strong>Order ID:</strong> <%= order._id %></p>
        <p><strong>Order Date:</strong> <%= order.orderDate.toLocaleString() %></p>

        <% if (order.status !== 'Cancelled') { %>
          <p>
            <strong>Expected Delivery:</strong>
            <span class="text-success fw-semibold">
              <%= expectedDelivery.toDateString() %>
            </span>
          </p>

          <% if (order.status !== 'Delivered') { %>
            <div class="alert alert-info py-2">
              üöö Your order is expected to arrive by
              <strong><%= expectedDelivery.toDateString() %></strong>
            </div>
          <% } %>
        <% } %>

        <p><strong>Status:</strong>
          <span class="badge 
            <%= order.status === 'Pending' ? 'bg-warning' :
                order.status === 'Confirmed' ? 'bg-info' :
                order.status === 'Shipped' ? 'bg-primary' :
                order.status === 'Delivered' ? 'bg-success' :
                'bg-danger' %>">
            <%= order.status %>
          </span>
        </p>
      </div>

      <!-- üì¶ Products -->
      <div class="card shadow-sm mb-4 p-4 border-0 rounded-4">
        <h4 class="mb-3">Products</h4>
        <% let totalAmount = 0; %>

        <% order.items.forEach(item => { %>
          <% if (item.productId) { 
               const product = item.productId;
               const itemTotal = product.current_price * item.quantity;
               totalAmount += itemTotal;
          %>
            <div class="d-flex flex-column flex-md-row mb-3 align-items-start align-items-md-center p-3 border rounded-3 bg-white">
              <img src="<%= product.image %>" class="product-img mb-2 mb-md-0" alt="product">
              <div class="ms-md-3 flex-grow-1">
                <h5 class="mb-1"><%= product.item_name %></h5>
                <p class="text-muted mb-1"><%= product.company %></p>
                <p class="mb-0">
                  Qty: <%= item.quantity %> |
                  <strong>‚Çπ <%= itemTotal %></strong>
                </p>
              </div>
            </div>
          <% } %>
        <% }) %>

        <hr>
        <h5 class="text-end">
          Total Amount (COD): ‚Çπ <%= totalAmount %>
        </h5>
      </div>

      <!-- üè† Delivery Address -->
      <div class="card shadow-sm mb-4 p-4 border-0 rounded-4">
        <h4 class="mb-3">Delivery Address</h4>
        <p><strong><%= order.name %></strong></p>
        <p class="mb-1"><%= order.house %>, <%= order.locality %></p>
        <p class="mb-1"><%= order.city %> - <%= order.pincode %>, <%= order.state %></p>
        <p><strong>Mobile:</strong> <%= order.mobile %></p>
      </div>

      <!-- üìç Order Tracking -->
      <div class="card shadow-sm mb-4 p-4 border-0 rounded-4">
        <h4 class="mb-3">Order Tracking</h4>

        <div class="progress-step-container d-flex flex-column flex-md-row justify-content-between mb-3 text-center text-md-start">
          <div class="step active mb-2 mb-md-0">Order Placed</div>
          <div class="step <%= ['Confirmed','Shipped','Delivered','Cancelled'].includes(order.status) ? 'active' : '' %> mb-2 mb-md-0">
            Confirmed
          </div>
          <div class="step <%= ['Shipped','Delivered'].includes(order.status) ? 'active' : '' %> mb-2 mb-md-0">
            Shipped
          </div>
          <% if (order.status === 'Cancelled') { %>
            <div class="step active text-danger">Cancelled</div>
          <% } else { %>
            <div class="step <%= order.status === 'Delivered' ? 'active' : '' %>">
              Delivered
            </div>
          <% } %>
        </div>

        <div class="progress mb-4" style="height:6px;">
          <div class="progress-bar
            <%= order.status === 'Cancelled' ? 'bg-danger' : 'bg-success' %>"
            style="width:
            <%= order.status === 'Pending' ? '25%' :
                order.status === 'Confirmed' ? '50%' :
                order.status === 'Shipped' ? '75%' :
                order.status === 'Delivered' ? '100%' :
                order.status === 'Cancelled' ? '50%' : '25%' %>;">
          </div>
        </div>

        <% if (order.status === 'Cancelled') { %>
          <div class="alert alert-danger mt-3">
            ‚ùå This order has been cancelled.  
            Any payment (if made) will be refunded within 5‚Äì7 business days.
          </div>
        <% } %>
      </div>

      <a href="/order" class="btn btn-primary w-100 rounded-4 py-2">
        Back to Orders
      </a>

    </div>
  </div>
</div>