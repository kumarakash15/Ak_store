<% layout("/layout/bollerplate") %>
<body>
<div class="container mt-3">
  <div class="row">

    <!-- LEFT: ORDER + ADDRESS -->
    <div class="col-12 col-md-7 mb-4">

      <!-- ðŸ›’ ORDER SUMMARY -->
      <div class="card shadow-sm mb-4 p-3">
        <h4>Order Summary</h4>

        <% let totalAmount = 0; %>

        <% order.items.forEach(item => { %>
          <% 
            const product = item.productId;
            const itemTotal = product.current_price * item.quantity;
            totalAmount += itemTotal;
          %>

          <div class="d-flex flex-column flex-md-row align-items-center mt-3">
            <img src="<%= product.image %>"
              class="img-fluid mb-2 mb-md-0"
              style="width:110px;height:110px;border-radius:10px;object-fit:cover">

            <div class="ms-md-3 text-center text-md-start flex-grow-1">
              <h5><%= product.item_name %></h5>
              <p class="text-muted mb-1"><%= product.company %></p>
              <p class="fw-bold mb-1">â‚¹ <%= product.current_price %></p>
              <p class="mb-1">Qty: <%= item.quantity %></p>
              <p class="fw-bold mb-0">Item Total: â‚¹ <%= itemTotal %></p>
            </div>
          </div>
        <% }) %>

        <hr>
        <h5 class="text-end">Total Amount: â‚¹ <%= totalAmount %></h5>
      </div>

      <!-- ðŸ“¦ DELIVERY ADDRESS -->
      <div class="card shadow-sm p-3">
        <h4>Delivery Address</h4>

        <p class="fw-bold"><%= order.name %></p>
        <p class="mb-1">
          <%= order.house %>, <%= order.locality %>,<br>
          <%= order.city %> - <%= order.pincode %><br>
          <%= order.state %>
        </p>
        <p class="fw-bold mb-0">Mobile: <%= order.mobile %></p>
      </div>

    </div>

    <!-- RIGHT: PAYMENT OPTIONS -->
    <div class="col-12 col-md-5">

      <div class="card shadow-sm p-4">

        <h4>Payment Options</h4>

        <!-- DISABLED OPTIONS -->
        <div class="form-check mt-3 text-muted">
          <input class="form-check-input" type="radio" disabled>
          <label class="form-check-label">
            UPI <span class="badge bg-secondary ms-2">Unavailable</span>
          </label>
        </div>

        <div class="form-check mt-2 text-muted">
          <input class="form-check-input" type="radio" disabled>
          <label class="form-check-label">
            Card <span class="badge bg-secondary ms-2">Unavailable</span>
          </label>
        </div>

        <hr>

        <!-- COD -->
        <div class="form-check mt-3">
          <input class="form-check-input" type="radio" id="codRadio">
          <label class="form-check-label fw-bold">
            Cash on Delivery (COD)
          </label>
          <p class="text-muted small mb-0">OTP verification required</p>
        </div>

        <button id="sendOtpBtn" class="btn btn-primary w-100 mt-3" disabled>
          Send OTP
        </button>

        <div id="otpBox" style="display:none" class="mt-3">
          <input type="number" id="otpInput" class="form-control mb-2" placeholder="Enter OTP">
          <p id="otpTimer" class="text-muted small mt-2"></p>
          <button id="verifyOtpBtn" class="btn btn-success w-100 mt-2">
            Confirm Order
          </button>
        </div>

      </div>

    </div>

  </div>
</div>

<script>
const sendOtpBtn = document.getElementById("sendOtpBtn");
const otpBox = document.getElementById("otpBox");
const otpInput = document.getElementById("otpInput");
const verifyOtpBtn = document.getElementById("verifyOtpBtn");
const codRadio = document.getElementById("codRadio");
const otpTimerEl = document.getElementById("otpTimer");
let otpInterval;

// Enable send button when COD selected
codRadio.addEventListener("change", () => {
  sendOtpBtn.disabled = !codRadio.checked;
});

// Send OTP
sendOtpBtn.addEventListener("click", async () => {
  sendOtpBtn.disabled = true;
  const res = await fetch("/send-otp", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mobileNumber: "<%= order.mobile %>",
      orderId: "<%= order._id %>"
    })
  });

  const data = await res.json();
  if (data.success) {
    otpBox.style.display = "block";
    alert("OTP sent successfully");
    startOtpTimer(300);
  } else {
    alert(data.message);
    sendOtpBtn.disabled = false;
  }
});

// OTP timer
function startOtpTimer(duration) {
  clearInterval(otpInterval);
  let timer = duration;

  otpInterval = setInterval(() => {
    const minutes = Math.floor(timer / 60);
    const seconds = timer % 60;
    otpTimerEl.textContent = `OTP expires in ${minutes}:${seconds < 10 ? '0'+seconds : seconds}`;

    if (timer <= 0) {
      clearInterval(otpInterval);
      otpTimerEl.textContent = "OTP expired. Please resend OTP.";
      sendOtpBtn.disabled = false;
    }
    timer--;
  }, 1000);
}

// Verify OTP
verifyOtpBtn.addEventListener("click", async () => {
  const userOtp = otpInput.value.trim();
  if (!userOtp) return alert("Enter OTP");
  const res = await fetch("/verify-otp", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userOtp,
      orderId: "<%= order._id %>"
    })
  });
  const data = await res.json();
  if (data.success) window.location.href = "/order-success";
  else alert(data.message);
});
</script>
</body>